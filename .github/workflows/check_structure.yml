name: VÃ©rification de l'arborescence et des fichiers

on:
  push:
  pull_request:

jobs:
  check-structure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: VÃ©rifier l'arborescence
        run: |
          echo "ðŸ” VÃ©rification de l'arborescence du projet..."
          
          required_dirs=("site" "site/img" "site/css" "site/js" "src")
          
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "âŒ Erreur : Dossier manquant -> $dir"
              exit 1
            fi
          done

          echo "âœ… Arborescence correcte."

      - name: VÃ©rifier les types de fichiers
        run: |
          echo "ðŸ” VÃ©rification des fichiers..."

          declare -A allowed_extensions
          allowed_extensions=( 
            ["site"]="html php"
            ["site/img"]="png jpg jpeg"
            ["site/css"]="css"
            ["site/js"]="js"
          )

          # Fonction pour vÃ©rifier un seul fichier Ã  la fois
          check_file() {
            local file=$1
            local dir=$2
            local valid_exts=$3
            
            # Extraction de l'extension et mise en minuscules
            ext="${file##*.}"
            ext="${ext,,}"

            # Affichage du fichier et de son extension pour dÃ©bogage
            echo "ðŸ” VÃ©rification du fichier : $file (extension : $ext)"

            # VÃ©rifier si l'extension est valide
            if ! echo "$valid_exts" | grep -wq "$ext"; then
              echo "âŒ Erreur : Fichier non conforme -> $file"
              exit 1  # ArrÃªte immÃ©diatement si un fichier est invalide
            fi
          }

          # VÃ©rification de chaque fichier dans son dossier
          for dir in "${!allowed_extensions[@]}"; do
            if [ -d "$dir" ]; then
              while IFS= read -r -d '' file; do
                check_file "$file" "$dir" "${allowed_extensions[$dir]}"
              done < <(find "$dir" -type f ! -name ".gitkeep" -print0)
            fi
          done

          echo "âœ… Tous les fichiers sont conformes."
